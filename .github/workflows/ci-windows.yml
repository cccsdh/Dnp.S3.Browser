name: CI - Build/Test/Package (Windows)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Test
        run: |
          # run all tests if present
          dotnet test --no-build --verbosity normal || echo "No tests or tests failed"

      - name: Publish MSIX package (Windows)
        shell: powershell
        run: |
          $proj = "Dnp.S3.Browser.UI\Dnp.S3.Browser.UI.csproj"
          dotnet restore $proj
          # Try to produce an MSIX / Appx package via MSBuild publish targets. This may create an .msix or .appx under the project output folders.
          dotnet msbuild $proj /t:Restore,Publish /p:Configuration=Release /p:Platform=x64 /p:CreateAppxPackage=true /p:AppxBundle=Always /p:AppxBundlePlatforms=x64

          # Look for generated MSIX or APPX package
          $pkg = Get-ChildItem -Path . -Include *.msix,*.appx,*.msixbundle -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($pkg -ne $null) {
              Write-Host "Found package: $($pkg.FullName)"
              $publishDir = Split-Path $pkg.FullName -Parent
          } else {
              Write-Host "No MSIX/MSIXBUNDLE/APPX found - falling back to folder publish"
              $publishDir = Join-Path -Path (Get-Location) -ChildPath "artifacts\publish"
              dotnet publish $proj -c Release -r win-x64 --self-contained false -o $publishDir
          }
          Write-Host "Publish output at: $publishDir"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: Dnp.S3.Browser.Windows.Release
          path: |
            **/*.msix
            **/*.msixbundle
            **/*.appx
            artifacts/publish/**
